/**
 * @file Firebase Security Rules for Firestore.
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model, where each user can only
 *                access and modify data associated with their own user ID. This ensures data
 *                privacy and prevents unauthorized access.
 *
 * @data_structure The data is organized hierarchically under `/users/{userId}`, with each user
 *                 having their own collection of `students`. The user's profile data is stored
 *                 directly under the `/users/{userId}` document.
 *
 * @key_security_decisions
 *   - User listing is explicitly disallowed to protect user privacy.
 *   - Anonymous authentication is enabled.
 *   - Data validation is relaxed to allow for flexible data shapes during prototyping, except
 *     for critical fields that ensure relational integrity and ownership.
 *
 * @denormalization_for_authorization Not applicable in this simple case. The ownership is derived directly
 *                                from the path.
 *
 * @structural_segregation Not applicable. All user data is private.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     * @return {boolean} True if the request is authenticated, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * @param {string} userId The user ID to compare against the request's auth UID.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource and it exists.
     * @param {string} userId The user ID to compare against the request's auth UID.
     * @return {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Security rules for user documents.
     * @path /users/{userId}
     * @allow (create) - Allow user to create their own user document.
     *          Example: request.auth.uid = 'user123', userId = 'user123'
     * @allow (get) - Allow user to get their own user document.
     *          Example: request.auth.uid = 'user123', userId = 'user123'
     * @allow (update) - Allow user to update their own user document.
     *          Example: request.auth.uid = 'user123', userId = 'user123'
     * @allow (delete) - Allow user to delete their own user document.
     *          Example: request.auth.uid = 'user123', userId = 'user123'
     * @deny  (create) - Deny user to create other user's document.
     *          Example: request.auth.uid = 'user456', userId = 'user123'
     * @deny  (get) - Deny user to get other user's document.
     *          Example: request.auth.uid = 'user456', userId = 'user123'
     * @deny  (update) - Deny user to update other user's document.
     *          Example: request.auth.uid = 'user456', userId = 'user123'
     * @deny  (delete) - Deny user to delete other user's document.
     *          Example: request.auth.uid = 'user456', userId = 'user123'
     * @principle Enforces user-ownership for all operations on user documents.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Security rules for student documents under a user.
     * @path /users/{userId}/students/{studentId}
     * @allow (create) - Allow user to create student document under their own user.
     *          Example: request.auth.uid = 'user123', userId = 'user123'
     * @allow (get) - Allow user to get student document under their own user.
     *          Example: request.auth.uid = 'user123', userId = 'user123'
     * @allow (update) - Allow user to update student document under their own user.
     *          Example: request.auth.uid = 'user123', userId = 'user123'
     * @allow (delete) - Allow user to delete student document under their own user.
     *          Example: request.auth.uid = 'user123', userId = 'user123'
     * @deny  (create) - Deny user to create student document under other user's document.
     *          Example: request.auth.uid = 'user456', userId = 'user123'
     * @deny  (get) - Deny user to get student document under other user's document.
     *          Example: request.auth.uid = 'user456', userId = 'user123'
     * @deny  (update) - Deny user to update student document under other user's document.
     *          Example: request.auth.uid = 'user456', userId = 'user123'
     * @deny  (delete) - Deny user to delete student document under other user's document.
     *          Example: request.auth.uid = 'user456', userId = 'user123'
     * @principle Enforces user-ownership for all operations on student documents.
     */
    match /users/{userId}/students/{studentId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}